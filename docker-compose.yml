version: "3.4"

services:
  vaultwarden:
    image: vaultwarden/server:latest
    networks:
      - network_cluster
    volumes:
      - homenas_vaultwarden:/data
    environment:
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=false
    env_file:    
      # 包含ADMIN_TOKEN 
      - ../../stack.env      
    restart: always
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.cloudvalley.name`)"
        - "traefik.http.routers.vaultwarden.entrypoints=websecure"
        - "traefik.http.routers.vaultwarden.service=vaultwarden"
        - "traefik.http.routers.vaultwarden.middlewares=noauth-chain@file"
        - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"     
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.nas == primary

  registry:
    image: registry
    networks:
      - network_cluster
    restart: always
    ports:
      - 25000:5000
    volumes:
      - homenas_registry:/var/lib/registry
    env_file: 
      - ../../stack.env       
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.registry.rule=Host(`registry.cloudvalley.name`)"
        - "traefik.http.routers.registry.entrypoints=websecure"
        - "traefik.http.routers.registry.service=registry"
        - "traefik.http.routers.registry.middlewares=noauth-chain@file"
        - "traefik.http.services.registry.loadbalancer.server.port=5000"     
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.type == nas

  registryui:
    image: snagles/docker-registry-manager:latest
    command: ["/app/app","-r","/app/conf/registries.yml"]
    networks: 
      - network_cluster
    environment:
      - MANAGER_PORT=8080
      # NFS挂载卷不支持文件映射，只支持目录映射
      # 通过命令行更改/app/registries.yml的默认位置为/app/conf/registries.yml
      #- MANAGER_REGISTRIES=/app/conf/registries.yml
      - MANAGER_LOG_LEVEL=warn
    volumes:
      - homenas_registryui:/app/conf
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.registryui.rule=Host(`registryui.cloudvalley.name`)"
        - "traefik.http.routers.registryui.entrypoints=websecure"
        - "traefik.http.routers.registryui.service=registryui"
        - "traefik.http.routers.registryui.middlewares=noauth-chain@file"
        - "traefik.http.services.registryui.loadbalancer.server.port=8080" 
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.type == nas
                    
networks:
  network_cluster:
    external: true
     
x-common-keys-volume: &common-keys-volume
  type: nfs
  o: addr=192.168.11.99,rw,nfsvers=4
  
volumes:
  homenas_vaultwarden:
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :/volume1/docker/swarm/storage/vaultwarden/data
  homenas_registry:
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :/volume1/docker/swarm/storage/registry
  homenas_registryui:
    driver: local
    driver_opts:
      <<: *common-keys-volume
      device: :/volume1/docker/swarm/storage/docker-registry-manager/conf    